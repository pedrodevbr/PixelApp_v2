<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="images/new_favicon.png" type="image/png" />
    <title>Falling Image App</title>

    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/partials/page-header.css" />
    <link rel="stylesheet" href="styles/partials/cards.css" />
    <link rel="stylesheet" href="styles/partials/buttons.css" />
    <link rel="stylesheet" href="styles/partials/forms.css" />
    <link rel="stylesheet" href="styles/partials/animations.css" />
    <link rel="stylesheet" href="styles/pages/job.css" />

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

  </head>
  <body>
    
    <header class="page-header inner">
      <h1 align='center'>Transform your image</h1>
    </header>

    <div class="container flex animate-up delay-2">
      <main>
        <div id="form-job">
          <fieldset>
            <legend>Image</legend>
            <div class="separator light"></div>

            <div class="input-group">
              <div class="input-wrapper">
                <label for="Image ID">Image ID</label>
                <input 
                  type="number"
                  step="1" 
                  id="image_id input" 
                  />
                  <h3 style='color:black' align='center'>Features found:</h1>
                  <p id='features_found' style="color:black;"align='center' >-</p>
                  
                  <div class="input-group">
                    <label for="Falling FPS">
                      Frames per second:
                    </p>
                    <input
                      type="number"
                      id=fps
                      step="1" 
                    />
                  
                  </div>
              </div>

              <div class="input-wrapper">
                <label for="total-hours">Selected</label>
                <div>
                  <canvas width="240" height="240" id='selected_image'>
                </div>
                
                <script >
                  
                  let img_array = []
                  let blocked_pixels = []
                  let image_id = ''
                  let delay = 250
                  let bp = {}
                  fetch('blocked_pixels.json')
                        .then(response=>response.json())
                        .then(data=>{bp = data}) 
                  async function melt(img_array,blocked_pixels){
                    const BACKGROUND_COLOR = 'A0A0A0'
                    for (let i = 0;i<40;i++){
                        document.addEventListener('keypress',function (e){
                            if (e.key === 'Enter'){i = 1000} //To exit the for loop
                        })  
                             
                        for (let index = 24*24 ; index > 0; index--){
                            y = Math.floor(index/24)
                            x = index%24
                            if(blocked_pixels.includes(`${x}:${y}`)){
                                
                                continue
                            }
                            if(img_array[index]==BACKGROUND_COLOR){
                                continue
                            }
                            else if (x==23){ //right border
                                if (img_array[x-1+(y+1)*24] == BACKGROUND_COLOR){
                                    img_array[x-1+(y+1)*24] = img_array[x+y*24]}
                            }
                            else if (x==0){//#left border
                                if (img_array[x+1+(y+1)*24] == BACKGROUND_COLOR){
                                    img_array[x+1+(y+1)*24] = img_array[x+y*24]}
                            }
                            else{
                                
                                //console.log(x,y)
                                var y_down = y+1
                                var x_right= x-1
                                var x_left = x+1
                                
                                while (blocked_pixels.includes(`${x}:${y_down}`)){
                                  y_down+=1
                                  while (blocked_pixels.includes(`${x_right}:${y_down}`)){
                                    x_right-=1
                                    if(x_right==0){break}
                                    while (blocked_pixels.includes(`${x_left}:${y_down}`)){
                                      x_left+=1
                                      if(x_left==23){break}
                                    }
                                  }
                                }
                                
                                
                                
                                
                                if(img_array[x+y_down*24]==BACKGROUND_COLOR){
                                    //console.log('Down')
                                    img_array[x+y_down*24] = img_array[x+y*24]
                                    img_array[x+y*24] = BACKGROUND_COLOR
                                }

                                /*
                                else if (img_array[x_right+y_down*24] == BACKGROUND_COLOR && img_array[x_left+y_down*24] == BACKGROUND_COLOR){
                                    d = Math.round(Math.random())
                                    //console.log(d)
                                    img_array[(x+d)+y_down*24] = img_array[x+y*24]
                                    img_array[x+y*24] = BACKGROUND_COLOR
                                }*/
                                else if (img_array[x_right+y_down*24] != BACKGROUND_COLOR && img_array[x_left+y_down*24] == BACKGROUND_COLOR){
                                    img_array[x_left+y_down*24] = img_array[x+y*24]
                                    img_array[x+y*24] = BACKGROUND_COLOR
                                }
                                else if (img_array[x_right+y_down*24] == BACKGROUND_COLOR && img_array[x_left+y_down*24] != BACKGROUND_COLOR){
                                    img_array[x_right+y_down*24] = img_array[x+y*24]
                                    img_array[x+y*24] = BACKGROUND_COLOR
                                }
                                else{
                                    continue
                                }                                           
                            }
                        }
                        await sleep(delay);
                        draw_image(img_array,"result_image") 
                    }
                }

                  function sleep(ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                }

                  function draw_image(img_array,canvas){
                    const pixel_size = 10
                    var canvas = document.getElementById(canvas);
                    var context = canvas.getContext("2d");
                    img_array.forEach(function(profile,index){
                        x = Math.floor(index/24)
                        y = index%24
                        context.fillStyle = '#'+profile;
                        context.fillRect(y*pixel_size, x*pixel_size, pixel_size, pixel_size);
                    })
                  }

                  function decode(data){
                    let img_array =[]
                    BACKGROUND_COLOR = 'A0A0A0'
                    for (let index = 0; index < 24*24; index++){
                        img_array[index] = BACKGROUND_COLOR
                    }
                    for (let index = 0; index < data.length; index++){ 
                      element = data[index]
                      x = parseInt(element.x)
                      y = parseInt(element.y)
                      img_array[y*24+x] = element.color
                    }
                    return img_array
                  }
                  
                  document.addEventListener('input',()=>{
                    image_id = parseInt(document.getElementById('image_id input').value)
                    
                    if (isNaN(image_id)){
                        image_id='not_found'
                    }
                    let data_src = `./images/json images/${image_id}.json`
                    
                    fetch(data_src)
                        .then(response=>response.json())
                        .then(data=>{                      
                          img_array = decode(data)
                          draw_image(img_array,'selected_image')
                        })                     
                  });
                  
                  document.addEventListener('keypress',function (e){
                    if (e.key === 'Enter'){
                        blocked_pixels = bp[image_id]
                        if(blocked_pixels===undefined){
                            blocked_pixels=[]
                        }
                        delay = 1000/parseInt(document.getElementById('fps').value)
                        if (isNaN(delay)){
                          delay=250
                        }
                        console.log(delay)
                        melt(img_array,blocked_pixels)
                    }
                  });

                </script>
              </div>
            </div>
          </fieldset>
    
        </div>
      </main>
      <aside class="card">
        <div>
          <canvas id='result_image' width="240" height="240"> </canvas>
        </div>
                
        <script> 
          function save_image(){
            let image_id = document.getElementById('image_id input').value
            var canvas = document.getElementById( 'result_image' );  
            // get canvas data  
            var image = canvas.toDataURL();  
            
            // create temporary link  
            var tmpLink = document.createElement( 'a' );  
            tmpLink.download = `image${image_id}_result.png`; // set the name of the download file 
            tmpLink.href = image;  

            // temporarily add link to body and initiate the download  
            document.body.appendChild( tmpLink );  
            tmpLink.click();  
            document.body.removeChild( tmpLink ); 
          }
        </script>
        <button onclick='save_image()'
          class="button green"  
         >Download Image</button>

      </aside>
      
    </div>
    <!-- end container -->
  </body>
</html>
 